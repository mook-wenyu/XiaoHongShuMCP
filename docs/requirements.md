# 需求摘要

| 字段 | 内容 |
| --- | --- |
| 更新时间 | 2025-09-28 |
| 责任人 | Codex |
| 关联提交 | 待提交 |

## 当前任务需求

### TASK-20250927-004
- `profileKey` 统一作为浏览器键与（独立模式）目录名，取消 `folderName` 字段；用户模式仍允许显式 `profilePath`，独立模式禁止额外路径参数。
- 用户模式工具执行前自动检测缓存，缺失时自动探测或使用显式路径打开浏览器；独立模式需显式调用 `xhs_browser_open`。
- 浏览器会话结果新增 `ProfileDirectoryName`、`AutoOpened` 等字段，所有工具元数据需同步返回。
- 所有 MCP 工具方法及其参数需添加 `Description("中文 | English")` 注解，Schema 暴露双语说明。
- 所有工具请求体必须携带 `browserKey`（默认 `user`），以匹配上述缓存与自动打开策略。

### TASK-20250927-005
- 打造可参数化的拟人化行为模型（延迟、鼠标、键盘、滚动等），用于在执行 Playwright 工具前后模拟真实用户节奏。
- 引入浏览器指纹伪装与防探测策略：基于 `profileKey` 绑定用户数据目录、随机化 UA/时区/语言、隐藏 WebDriver、注入 Canvas/WebGL 扰动。
- 构建网络层防护：请求节流、随机失败重试、代理轮换/带宽模拟，减少短时高频特征。
- 统一日志与监控结构，记录行为参数、指纹摘要、网络出口、失败原因，为风控分析与调优提供证据。
- 设计回退策略：检测到风控信号时自动降级操作频率或转人工确认，并在文档中记录风险。

### TASK-20250927-003
- 在独立浏览器模式下，`profilePath` 不再允许传入，使用固定目录 `storage/browser-profiles/<folderName>`；必须提供 `folderName` 并作为缓存键默认值。
- 为打开的浏览器会话维护字典缓存，用户浏览器默认使用键 `user`，独立配置以传入的 `profileKey` 或 `folderName` 作为键；禁止同名键覆盖，不同路径时报错。
- 当请求与已打开会话键与路径完全一致时，返回警告并复用已有结果。
- 工具与服务接口需同步支持新参数（键名、目录名），并返回使用的键、路径、是否复用等信息。

### TASK-20250927-002
- 停止服务器启动阶段的自动浏览器启动，改为通过工具显式打开。
- 支持“用户浏览器配置”与“独立浏览器配置”两种模式，默认使用用户模式，可指定路径或自动发现/创建。
- 工具需返回实际路径、是否新建配置以及是否使用默认路径，文档同步说明。

### TASK-20250927-006
- 保持 `profileKey` 单字段语义，`user` 自动探测并拉起浏览器，其它键必须显式打开，禁止同名键覆盖。
- 将指纹、网络策略与拟人化行为绑定至会话元数据，记录指纹哈希、代理与缓解次数等指标。
- 所有 MCP 工具方法与参数采用 `Description("中文说明 | English description")` 格式，元数据输出需含 `autoOpened` 与行为日志字段。
- 提供“调用前自动拉起或复用 user 浏览器”的封装，仍允许手动调用 `xhs_browser_open`。
- 支持通过 `verification.statusUrl` 配置示例验证使用的状态码端点，网络受限时可替换为内网服务。
- 支持通过 `verification.mockStatusCode` 在本地拦截并返回指定状态码，确保在离线或受限网络中仍能验证缓解逻辑。
- 更新文档、日志与验证流程，标注真实环境缺失的风险与后续计划。
