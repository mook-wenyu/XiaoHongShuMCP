# ADR-0001 并发治理与上下文池化

状态：Accepted（破坏性更改，不向后兼容）

日期：2025-09-12

## 背景
高并发、低熵节律与指纹同质会放大风控风险。项目需要一套工程化“并发治理 + 速率整形 + 熔断”的闭环，并为未来多上下文（多账号）运行铺路。

## 决策
- 引入 ConcurrencyGovernor（操作租约）：同账号写操作并发=1、只读=2（默认，可配）。
- 引入 TokenBucketRateLimiter：账号×端点类别令牌桶；Like≈1/20s、Collect≈1/30s、Comment≈1/5min；Search/Feed 更宽。
- 引入 SimpleCircuitBreaker：窗口120s内失败≥3→熔断600s。
- UniversalApiMonitor 增强：HTTP 429/403、captcha/geetest/verify URL 迹象→直接触发熔断。
- 上下文池 IBrowserContextPool：提供“租约化获取 Page/Context”抽象（当前阶段为单持久化Context的多页面池化）。

## 方案权衡
- 直接全量多 Context + 多 UserDataDir → 复杂度与资源开销高；本期采用“池化抽象+多页面”渐进演进。
- 随机化指纹 vs 稳定指纹：选择“稳定一致”以降低异常概率。

## 影响
- 所有写类操作串行化；搜索/Feed 接入速率整形；429/403/CAPTCHA 自动触发熔断。
- 代码新增接口：IConcurrencyGovernor、IRateLimiter、ICircuitBreaker、IBrowserContextPool；配置新增节 XHS:Concurrency。

## 迁移
- 无需数据迁移；如需调整阈值，通过环境变量覆盖 XHS:Concurrency:*。

## 度量
- 交互成功率、429/403 命中率、熔断触发次数、端点平均速率、写操作等待时延。

