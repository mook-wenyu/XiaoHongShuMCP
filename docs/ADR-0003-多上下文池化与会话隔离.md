# ADR-0003 多上下文池化与会话隔离

状态：Accepted（破坏性更改）

日期：2025-09-12

## 背景
多账号并发与会话隔离是反检测的重要前提。单一持久化上下文难以避免跨账号 LocalStorage/Cookie/指纹的相互影响。

## 决策
- 新增 `MultiContextBrowserPool`：每个账号独立 `UserDataDir`，通过 Playwright `LaunchPersistentContextAsync` 启动；
- 每上下文维护页面池（默认容量3），提供“页面租约 IContextLease”给上层；
- 健康清理：定时移除关闭页面；页面创建失败时重建上下文（下一步集成健康状态机与崩溃自愈）。

## 接口与兼容性
- `IBrowserContextPool.AcquireAsync(accountId, purpose, ct)`（破坏性变更），调用方需传入账户标识；
- 现有服务统一从 `IAccountManager.CurrentUser.UserId` 提取并传入。

## 配置
- `XHS:Concurrency:Pool:MaxPages` 控制每上下文页面池容量（默认3）。

## 风险与缓解
- 资源占用上升：通过容量上限与 `IConcurrencyGovernor` 写串行控制；
- 进程崩溃：后续将加入状态机与重建策略（下一阶段）。

## 验收与度量
- 真实环境（RealEnv）确认每账号 `UserDataPool/<accountId>` 目录独立生成；
- 交互成功率提升、429/403 命中率下降、不同账号之间会话无污染。

